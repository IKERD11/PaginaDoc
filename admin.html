<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Administrativo - Sistema de Gestión Documental</title>
    <link rel="icon" type="image/x-icon"
        href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA">
    <link rel="stylesheet" href="css/estilos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="admin-page">
    <!-- Formas decorativas animadas en el fondo -->
    <div class="page-shapes">
        <div class="page-shape"></div>
        <div class="page-shape"></div>
        <div class="page-shape"></div>
    </div>

    <!-- Barra de navegación -->
    <nav class="navbar navbar-glass">
        <div class="navbar-content">
            <!-- Botón hamburguesa (visible solo en móvil) -->
            <button class="btn-hamburger" id="btnHamburger" aria-label="Abrir menú">
                <i class="fas fa-bars"></i>
            </button>
            <div class="navbar-brand">
                <img src="img/logo-tec.png" alt="Logo TecNM"
                    style="width: 28px; height: 28px; object-fit: contain; margin-right: 4px;">
                <span>Panel Administrativo</span>
            </div>
            <div class="navbar-menu">
                <span class="user-info">
                    <i class="fas fa-user-shield"></i>
                    <span id="adminName">Administrador</span>
                </span>
                <button id="logoutBtn" class="btn-logout">
                    <i class="fas fa-sign-out-alt"></i>
                    Cerrar Sesión
                </button>
            </div>
        </div>
    </nav>

    <!-- Overlay para cerrar sidebar en móvil -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <div class="layout-container">
        <aside class="sidebar sidebar-glass" id="sidebar">
            <div class="sidebar-header">
                <button class="sidebar-toggle" id="btnSidebarToggle" aria-label="Toggle Sidebar">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <ul class="sidebar-menu">

                <!-- Ítem simple: Dashboard -->
                <li class="menu-item active" data-section="dashboard" data-tooltip="Dashboard">
                    <i class="fas fa-chart-line"></i>
                    <span>Dashboard</span>
                </li>

                <!-- Grupo: Gestión -->
                <li class="nav-group" data-tooltip="Gestión">
                    <button class="nav-group__trigger" aria-expanded="false">
                        <i class="fas fa-folder-open"></i>
                        <span class="nav-group__label">Gestión</span>
                        <i class="fas fa-chevron-down nav-group__chevron"></i>
                    </button>
                    <div class="nav-group__body">
                        <ul class="nav-group__list">
                            <li class="menu-item menu-item--child" data-section="alumnos">
                                <i class="fas fa-users"></i>
                                <span>Alumnos</span>
                            </li>
                            <li class="menu-item menu-item--child" data-section="documentos">
                                <i class="fas fa-file-alt"></i>
                                <span>Documentos</span>
                            </li>
                        </ul>
                    </div>
                </li>

                <!-- Grupo: Comunicación -->
                <li class="nav-group" data-tooltip="Comunicación">
                    <button class="nav-group__trigger" aria-expanded="false">
                        <i class="fas fa-comments"></i>
                        <span class="nav-group__label">Comunicación</span>
                        <i class="fas fa-chevron-down nav-group__chevron"></i>
                    </button>
                    <div class="nav-group__body">
                        <ul class="nav-group__list">
                            <li class="menu-item menu-item--child" data-section="citas">
                                <i class="fas fa-calendar-alt"></i>
                                <span>Citas</span>
                            </li>
                            <li class="menu-item menu-item--child" data-section="mensajes">
                                <i class="fas fa-envelope"></i>
                                <span>Mensajes</span>
                                <span class="badge" id="mensajesBadge">0</span>
                            </li>
                        </ul>
                    </div>
                </li>

                <!-- Ítem simple: Reportes -->
                <li class="menu-item" data-section="reportes" data-tooltip="Reportes">
                    <i class="fas fa-chart-bar"></i>
                    <span>Reportes</span>
                </li>

                <!-- Ítem simple: Configuración -->
                <li class="menu-item" data-section="configuracion" data-tooltip="Configuración">
                    <i class="fas fa-cog"></i>
                    <span>Configuración</span>
                </li>

            </ul>
        </aside>


        <!-- Contenido principal -->
        <main class="main-content">
            <!-- Sección Dashboard -->
            <section id="dashboard-section" class="content-section active">
                <div class="section-header">
                    <h2><i class="fas fa-chart-line"></i> Dashboard General</h2>
                    <p>Resumen del estado del sistema</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalAlumnos">0</h3>
                            <p>Total de Alumnos</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon green">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="alumnosCompletos">0</h3>
                            <p>Documentación Completa</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon orange">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="documentosPendientes">0</h3>
                            <p>Documentos Pendientes</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon red">
                            <i class="fas fa-times-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="documentosRechazados">0</h3>
                            <p>Documentos Rechazados</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-charts">
                    <div class="chart-card">
                        <h3><i class="fas fa-chart-pie"></i> Estado de Documentación</h3>
                        <div id="chartDocumentacion" class="chart-container"></div>
                    </div>

                    <div class="chart-card">
                        <h3><i class="fas fa-calendar-check"></i> Citas de la Semana</h3>
                        <div id="citasSemana" class="citas-list"></div>
                    </div>
                </div>
            </section>

            <!-- Sección Alumnos -->
            <section id="alumnos-section" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-users"></i> Gestión de Alumnos</h2>
                    <button class="btn-primary" id="btnNuevoAlumno">
                        <i class="fas fa-plus"></i> Nuevo Alumno
                    </button>
                </div>

                <div class="filter-bar">
                    <input type="text" id="searchAlumno" placeholder="Buscar por nombre o número de control...">
                    <select id="filterEstado">
                        <option value="">Todos los estados</option>
                        <option value="completo">Documentación Completa</option>
                        <option value="incompleto">Documentación Incompleta</option>
                        <option value="pendiente">Pendiente de Revisión</option>
                    </select>
                </div>

                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Número de Control</th>
                                <th>Nombre</th>
                                <th>Correo</th>
                                <th>Progreso</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="alumnosTableBody">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Sección Documentos -->
            <section id="documentos-section" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-file-alt"></i> Revisión de Documentos</h2>
                    <p>Revisa y aprueba/rechaza los documentos de los alumnos</p>
                </div>

                <div class="filtros-documentos">
                    <div class="filtros-row">
                        <div class="filtro-group" style="flex: 2;">
                            <label for="searchDocumento"><i class="fas fa-search"></i> Buscar documento</label>
                            <input type="text" id="searchDocumento"
                                placeholder="Buscar por número de control, correo o nombre del alumno..."
                                class="filtro-input">
                        </div>
                        <div class="filtro-group">
                            <label for="filterAlumnoDocumentos">Alumno</label>
                            <select id="filterAlumnoDocumentos" class="filtro-select">
                                <option value="">Todos los alumnos</option>
                            </select>
                        </div>
                        <div class="filtro-group">
                            <label for="filterEstadoDocumento">Estado</label>
                            <select id="filterEstadoDocumento" class="filtro-select">
                                <option value="">Todos los estados</option>
                                <option value="pendiente">Pendientes</option>
                                <option value="aprobado">Aprobados</option>
                                <option value="rechazado">Rechazados</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="documentosContainer" class="documentos-grid">
                    <!-- Se llenará dinámicamente -->
                </div>
            </section>

            <!-- Sección Citas -->
            <section id="citas-section" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-calendar-alt"></i> Gestión de Citas</h2>
                    <button class="btn-primary" id="btnNuevaCita">
                        <i class="fas fa-plus"></i> Agendar Cita
                    </button>
                </div>

                <div class="calendar-controls">
                    <button id="prevWeek"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="currentWeek">Semana Actual</h3>
                    <button id="nextWeek"><i class="fas fa-chevron-right"></i></button>
                </div>

                <div id="calendarContainer" class="calendar-grid">
                    <!-- Se llenará dinámicamente -->
                </div>

                <div class="citas-list-container">
                    <h3>Próximas Citas</h3>
                    <div id="citasList">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </section>

            <!-- Sección Mensajes -->
            <section id="mensajes-section" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-envelope"></i> Sistema de Mensajes</h2>
                    <button class="btn-primary" id="btnNuevoMensaje">
                        <i class="fas fa-plus"></i> Nuevo Mensaje
                    </button>
                </div>

                <div class="mensajes-container">
                    <div class="mensajes-list">
                        <div class="filter-bar">
                            <input type="text" id="searchMensaje" placeholder="Buscar mensajes...">
                            <select id="filterCategoria">
                                <option value="">Todas las categorías</option>
                                <option value="documento">Documentos</option>
                                <option value="cita">Citas</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                        <div id="mensajesListContainer">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <div class="mensaje-detalle">
                        <div id="mensajeDetalleContainer">
                            <div class="empty-state">
                                <i class="fas fa-envelope-open"></i>
                                <p>Selecciona un mensaje para ver los detalles</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Sección Reportes -->
            <section id="reportes-section" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-chart-bar"></i> Reportes y Estadísticas</h2>
                    <p>Genera y descarga reportes detallados del sistema</p>
                </div>

                <div class="glass-card fade-in">
                    <div class="reportes-grid">
                        <div class="form-group">
                            <label><i class="fas fa-filter"></i> Tipo de Reporte</label>
                            <div class="input-wrapper">
                                <select id="tipoReporte" class="input-glass">
                                    <option value="general">General</option>
                                    <option value="documentos">Documentos</option>
                                    <option value="citas">Citas</option>
                                    <option value="alumnos">Alumnos</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> Fecha Inicio</label>
                            <input type="date" id="fechaInicio" class="input-glass">
                        </div>

                        <div class="form-group">
                            <label><i class="fas fa-calendar"></i> Fecha Fin</label>
                            <input type="date" id="fechaFin" class="input-glass">
                        </div>

                        <div class="form-group report-actions">
                            <button class="btn-primary" id="generarReporte"
                                style="width: 100%; height: 48px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <i class="fas fa-bolt"></i> Generar Reporte
                            </button>
                        </div>
                    </div>
                </div>

                <div class="export-actions glass-container-light fade-in"
                    style="margin-top: 20px; padding: 15px; display: flex; justify-content: flex-end; align-items: center; gap: 10px; border-radius: 12px;">
                    <span style="margin-right: auto; font-weight: 500; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-download"></i> Exportar Resultados:
                    </span>
                    <button class="btn-secondary" id="exportPDF">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button class="btn-secondary" id="exportExcel">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                </div>

                <div id="reporteContainer" class="reporte-contenido fade-in" style="margin-top: 30px;">
                    <!-- Se llenará dinámicamente -->
                </div>
            </section>

            <!-- Sección Configuración -->
            <section id="configuracion-section" class="content-section">
                <div class="section-header">
                    <h2><i class="fas fa-cog"></i> Configuración del Sistema</h2>
                </div>

                <div class="config-tabs">
                    <button class="tab-btn active" data-tab="documentos-req">Documentos Requeridos</button>
                    <button class="tab-btn" data-tab="usuarios">Usuarios</button>
                    <button class="tab-btn" data-tab="periodos">Periodos</button>
                    <button class="tab-btn" data-tab="migracion">Migración de Datos</button>
                    <button class="tab-btn" data-tab="bitacora">Bitácora</button>
                </div>

                <div class="config-content">
                    <div id="documentos-req-tab" class="tab-content active">
                        <div class="section-header-actions"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">Documentos Obligatorios</h3>
                            <button class="btn-primary" id="btnAgregarDocumento">
                                <i class="fas fa-plus"></i> Agregar Documento
                            </button>
                        </div>
                        <div id="documentosRequeridos" class="documentos-req-list">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <div id="usuarios-tab" class="tab-content">
                        <div class="section-header-actions"
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0;">Gestión de Usuarios</h3>
                            <button class="btn-primary" id="btnAgregarUsuario">
                                <i class="fas fa-plus"></i> Agregar Usuario
                            </button>
                        </div>
                        <div id="usuariosList" class="usuarios-list">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>

                    <div id="periodos-tab" class="tab-content">
                        <h3>Configuración de Periodos</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Fecha Inicio Recepción:</label>
                                <input type="date" id="fechaInicioPeriodo">
                            </div>
                            <div class="form-group">
                                <label>Fecha Fin Recepción:</label>
                                <input type="date" id="fechaFinPeriodo">
                            </div>
                            <div class="form-group">
                                <label>Límite de Citas por Día:</label>
                                <input type="number" id="limiteCitasDia" min="1" max="50" value="10">
                            </div>
                        </div>
                        <button class="btn-primary" id="guardarPeriodo">
                            <i class="fas fa-save"></i> Guardar Configuración
                        </button>
                    </div>

                    <div id="migracion-tab" class="tab-content">
                        <h3><i class="fas fa-database"></i> Migración de Datos a Supabase</h3>
                        <div class="form-container" style="margin-bottom: 24px;">
                            <p style="color: rgba(255,255,255,0.8); margin-bottom: 20px;">
                                Esta herramienta migra todos los datos almacenados en localStorage (navegador) a la base
                                de datos de Supabase.
                                Esto incluye usuarios, documentos y otra información del sistema.
                            </p>

                            <div class="migration-warning-box">
                                <p class="migration-warning-title">
                                    <i class="fas fa-exclamation-triangle"></i> Importante
                                </p>
                                <p class="migration-warning-text">
                                    La migración no elimina los datos de localStorage. Los datos permanecerán como
                                    respaldo.
                                </p>
                            </div>

                            <div id="migracionStatus" style="margin-bottom: 20px; display: none;">
                                <!-- Se llenará con el estado de la migración -->
                            </div>

                            <div style="display: flex; gap: 12px; margin-bottom: 24px;">
                                <button class="btn-primary" id="btnEjecutarMigracion">
                                    <i class="fas fa-play"></i> Ejecutar Migración Completa
                                </button>
                                <button class="btn-secondary" id="btnVerificarMigracion">
                                    <i class="fas fa-check-circle"></i> Verificar Estado
                                </button>
                            </div>

                            <div id="migracionResultados" class="form-container" style="display: none;">
                                <!-- Se llenará con los resultados -->
                            </div>
                        </div>
                    </div>

                    <div id="bitacora-tab" class="tab-content">
                        <h3>Bitácora de Acciones</h3>
                        <div class="filter-bar">
                            <input type="text" id="searchBitacora" placeholder="Buscar en bitácora...">
                            <select id="filterTipoAccion">
                                <option value="">Todas las acciones</option>
                                <option value="login">Inicio de Sesión</option>
                                <option value="documento">Documentos</option>
                                <option value="cita">Citas</option>
                                <option value="usuario">Usuarios</option>
                            </select>
                        </div>
                        <div id="bitacoraList" class="bitacora-list">
                            <!-- Se llenará dinámicamente -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modales -->
    <div id="modalContainer"></div>


    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Inicialización Supabase -->
    <script src="js/supabase-init.js"></script>

    <!-- Scripts de configuración del proyecto -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>

    <!-- Sistema de autenticación -->
    <script src="js/auth.js"></script>
    <script src="js/supabase-utils.js"></script>

    <!-- Scripts de utilidades -->
    <!-- IMPORTANTE: storage.js debe cargar ANTES que documentos.js para que las funciones de Supabase no sean sobrescritas -->
    <script src="js/documentos.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/citas.js"></script>
    <script src="js/mensajes.js"></script>
    <script src="js/notificaciones.js"></script>
    <script src="js/gestor-archivos.js"></script>
    <script src="js/visor-documentos.js"></script>

    <!-- Reportes y gráficas -->
    <script src="js/reportes.js"></script>

    <!-- Utilidad de migración -->
    <script src="js/migracion.js"></script>

    <!-- Panel administrativo -->
    <script src="js/admin.js"></script>

    <!-- === SIDEBAR: Colapsar (escritorio) + Hamburguesa (móvil/tablet) === -->
    <script>
    (function () {
        'use strict';

        var DESKTOP_BREAKPOINT = 1025; // px — por encima de esto = escritorio

        var btnHamburger    = document.getElementById('btnHamburger');
        var btnCollapse     = document.getElementById('btnSidebarToggle');
        var sidebar         = document.getElementById('sidebar');
        var overlay         = document.getElementById('sidebarOverlay');
        var layoutContainer = document.querySelector('.layout-container');

        if (!sidebar) return;

        /* ─── HELPERS ─────────────────────────────────────────────────── */
        function isDesktop() { return window.innerWidth >= DESKTOP_BREAKPOINT; }

        /* ─── DRAWER (móvil / tablet) ────────────────────────────────── */
        function openDrawer() {
            sidebar.classList.add('sidebar-open');
            if (overlay) overlay.classList.add('active');
            if (btnHamburger) {
                btnHamburger.innerHTML = '<i class="fas fa-times"></i>';
                btnHamburger.setAttribute('aria-label', 'Cerrar menú');
            }
            document.body.style.overflow = 'hidden';
        }

        function closeDrawer() {
            sidebar.classList.remove('sidebar-open');
            if (overlay) overlay.classList.remove('active');
            if (btnHamburger) {
                btnHamburger.innerHTML = '<i class="fas fa-bars"></i>';
                btnHamburger.setAttribute('aria-label', 'Abrir menú');
            }
            document.body.style.overflow = '';
        }

        /* ─── COLLAPSE (escritorio) ──────────────────────────────────── */
        var STORAGE_KEY = 'adminSidebarCollapsed';

        function collapseSidebar() {
            sidebar.classList.add('sidebar-collapsed');
            if (layoutContainer) layoutContainer.classList.add('layout-collapsed');
            try { localStorage.setItem(STORAGE_KEY, '1'); } catch(e) {}
        }

        function expandSidebar() {
            sidebar.classList.remove('sidebar-collapsed');
            if (layoutContainer) layoutContainer.classList.remove('layout-collapsed');
            try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
        }

        function toggleCollapse() {
            if (sidebar.classList.contains('sidebar-collapsed')) {
                expandSidebar();
            } else {
                collapseSidebar();
            }
        }

        // Restaurar estado colapsado guardado
        try {
            if (localStorage.getItem(STORAGE_KEY) === '1' && isDesktop()) {
                collapseSidebar();
            }
        } catch(e) {}

        /* ─── EVENTOS ────────────────────────────────────────────────── */
        // Hamburguesa
        if (btnHamburger) {
            btnHamburger.addEventListener('click', function () {
                if (sidebar.classList.contains('sidebar-open')) {
                    closeDrawer();
                } else {
                    openDrawer();
                }
            });
        }

        // Botón toggle (desktop: colapsar / móvil: cerrar)
        if (btnCollapse) {
            btnCollapse.addEventListener('click', function (e) {
                e.stopPropagation();
                if (isDesktop()) {
                    toggleCollapse();
                } else {
                    closeDrawer();
                }
            });
        }

        /* ─── ACORDEÓN SIDEBAR ───────────────────────────────────────── */
        var accordionTriggers = document.querySelectorAll('.nav-group__trigger');

        accordionTriggers.forEach(function (trigger) {
            trigger.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();

                var parent = this.closest('.nav-group');
                var isExpanded = this.getAttribute('aria-expanded') === 'true';

                // Cerrar otros grupos (Lógica de Acordeón)
                accordionTriggers.forEach(function (otherTrigger) {
                    if (otherTrigger !== trigger) {
                        otherTrigger.setAttribute('aria-expanded', 'false');
                        otherTrigger.closest('.nav-group').classList.remove('is-expanded');
                    }
                });

                // Toggle actual
                if (!isExpanded) {
                    this.setAttribute('aria-expanded', 'true');
                    parent.classList.add('is-expanded');
                } else {
                    this.setAttribute('aria-expanded', 'false');
                    parent.classList.remove('is-expanded');
                }
            });
        });

        // Overlay cierra el drawer
        if (overlay) {
            overlay.addEventListener('click', closeDrawer);
        }

        // Cerrar drawer al navegar (tablet/móvil)
        sidebar.querySelectorAll('.menu-item').forEach(function (item) {
            item.addEventListener('click', function () {
                if (!isDesktop()) closeDrawer();
            });
        });

        // Escape
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                if (!isDesktop()) closeDrawer();
            }
        });

        // Resize: limpiar drawer al pasar a desktop
        var resizeTimer;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function () {
                if (isDesktop()) {
                    closeDrawer();
                } else {
                    // En móvil/tablet, quitar colapso si estaba
                    sidebar.classList.remove('sidebar-collapsed');
                    if (layoutContainer) layoutContainer.classList.remove('layout-collapsed');
                }
            }, 100);
        });
    })();
    </script>

</body>

    <!-- === CUSTOM SELECT — PORTAL A BODY (no se recorta por overflow) === -->
    <script>
    (function () {
        'use strict';

        /* ── Un solo dropdown activo en pantalla a la vez ── */
        var activeClose = null;

        function closeActive() {
            if (activeClose) { activeClose(); activeClose = null; }
        }

        /* ── Recalcula posición del portal cuando scroll/resize ── */
        function reposition(display, portal) {
            var rect = display.getBoundingClientRect();
            var spaceBelow = window.innerHeight - rect.bottom;
            var spaceAbove = rect.top;
            var ph = Math.min(290, portal.scrollHeight);

            if (spaceBelow >= ph || spaceBelow >= spaceAbove) {
                // Abrir hacia abajo
                portal.style.top  = (rect.bottom + 2) + 'px';
                portal.classList.remove('opens-up');
            } else {
                // Abrir hacia arriba
                portal.style.top  = (rect.top - ph - 2) + 'px';
                portal.classList.add('opens-up');
            }
            portal.style.left  = rect.left + 'px';
            portal.style.width = rect.width + 'px';
        }

        function initCustomSelect(nativeSelect) {
            if (nativeSelect.dataset.customSelectInit) return;
            nativeSelect.dataset.customSelectInit = 'true';

            /* 1. Wrapper + display */
            var wrapper = document.createElement('div');
            wrapper.className = 'custom-select-wrapper';

            var display = document.createElement('div');
            display.className = 'custom-select-display';
            display.setAttribute('role', 'combobox');
            display.setAttribute('tabindex', '0');
            display.setAttribute('aria-haspopup', 'listbox');
            display.setAttribute('aria-expanded', 'false');

            var textSpan = document.createElement('span');
            textSpan.className = 'cs-text';

            var arrowSpan = document.createElement('span');
            arrowSpan.className = 'cs-arrow';
            arrowSpan.innerHTML = '<i class="fas fa-chevron-down"></i>';

            display.appendChild(textSpan);
            display.appendChild(arrowSpan);

            nativeSelect.parentNode.insertBefore(wrapper, nativeSelect);
            wrapper.appendChild(display);
            wrapper.appendChild(nativeSelect);

            /* 2. Sincronizar texto visible */
            function syncDisplay() {
                var sel = nativeSelect.options[nativeSelect.selectedIndex];
                textSpan.textContent = sel ? sel.text : '';
            }
            syncDisplay();

            /* 3. Portal de opciones */
            var portal = null;
            var _reposBound = null;

            function buildPortal() {
                if (portal) portal.remove();
                portal = document.createElement('div');
                portal.className = 'custom-select-options';
                portal.setAttribute('role', 'listbox');
                /* Estilos de posicionamiento fijo */
                portal.style.cssText = 'position:fixed;z-index:99999;';

                Array.from(nativeSelect.options).forEach(function (opt) {
                    var isSelected = (opt.value === nativeSelect.value);

                    var item = document.createElement('div');
                    item.className = 'custom-select-option' + (isSelected ? ' selected' : '');
                    item.dataset.value = opt.value;
                    item.setAttribute('role', 'option');
                    item.setAttribute('aria-selected', isSelected ? 'true' : 'false');

                    /* Barra de acento */
                    var bar = document.createElement('span');
                    bar.className = 'cs-bar';

                    /* Etiqueta */
                    var label = document.createElement('span');
                    label.className = 'cs-opt-label';
                    label.textContent = opt.text;

                    /* Check de selección */
                    var check = document.createElement('span');
                    check.className = 'cs-opt-check';
                    check.innerHTML = '<i class="fas fa-check"></i>';

                    item.appendChild(bar);
                    item.appendChild(label);
                    item.appendChild(check);

                    item.addEventListener('mousedown', function (e) {
                        e.preventDefault();
                        nativeSelect.value = opt.value;
                        nativeSelect.dispatchEvent(new Event('change', { bubbles: true }));
                        syncDisplay();
                        close();
                    });

                    portal.appendChild(item);
                });

                document.body.appendChild(portal);
                reposition(display, portal);
            }

            function open() {
                closeActive();               // cerrar cualquier otro dropdown
                buildPortal();
                display.classList.add('open');
                display.setAttribute('aria-expanded', 'true');

                _reposBound = function () { reposition(display, portal); };
                window.addEventListener('scroll', _reposBound, true);
                window.addEventListener('resize', _reposBound);

                activeClose = close;
            }

            function close() {
                display.classList.remove('open');
                display.setAttribute('aria-expanded', 'false');
                if (portal) { portal.remove(); portal = null; }
                if (_reposBound) {
                    window.removeEventListener('scroll', _reposBound, true);
                    window.removeEventListener('resize', _reposBound);
                    _reposBound = null;
                }
                if (activeClose === close) activeClose = null;
            }

            function toggle() {
                display.classList.contains('open') ? close() : open();
            }

            /* 4. Eventos */
            display.addEventListener('click', function (e) {
                e.stopPropagation();
                toggle();
            });

            display.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); }
                if (e.key === 'Escape') close();
            });

            document.addEventListener('mousedown', function (e) {
                if (!wrapper.contains(e.target) && (!portal || !portal.contains(e.target))) {
                    close();
                }
            });

            /* 5. MutationObserver para cuando JS rellena <option> dinámicamente */
            var observer = new MutationObserver(function () {
                syncDisplay();
                if (display.classList.contains('open')) open(); // reconstruir
            });
            observer.observe(nativeSelect, { childList: true, attributes: true, subtree: true });

            nativeSelect.addEventListener('change', syncDisplay);
        }

        /* 6. Inicializar todos los selects en filter-bar y filtro-group */
        function initAll() {
            document.querySelectorAll(
                '.filter-bar select, .filtro-group select'
            ).forEach(initCustomSelect);
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAll);
        } else {
            initAll();
        }

        /* Re-inicializar cuando admin.js añade dinámicamente nuevos selects */
        var bodyObs = new MutationObserver(function () {
            document.querySelectorAll(
                '.filter-bar select:not([data-custom-select-init]),' +
                '.filtro-group select:not([data-custom-select-init])'
            ).forEach(initCustomSelect);
        });
        bodyObs.observe(document.body, { childList: true, subtree: true });
    })();
    </script>

</body>


</html>
